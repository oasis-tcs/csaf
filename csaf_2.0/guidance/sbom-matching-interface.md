## SBOM Matching Interface

This documents serves as a guidance how to implement an interface for a [CSAF SBOM matching matching system](https://docs.oasis-open.org/csaf/csaf/v2.0/os/csaf-v2.0-os.html#9117-conformance-clause-17-csaf-sbom-matching-system).

The matching interface defines several data structures. Its intention is to match the information on a CSAF data structure against a defined SBOM format. Different SBOM formats exist and can be mapped to this specification. The following three data structures need to be defined: 
- `SBOMDatabase`: A database of SBOMs
- `SBOM`: A single SBOM
- `SBOMComponent`: A single component in an SBOM

| Name                 | Properties                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|----------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `Matcher`            | The main interface for matching. It provides methods to match a list of CSAF document against a database of SBOMs. It contains the following properties: <br/>- `documents`: The CSAF documents to match against. <br/>The following operations MUST be supported:<br/>- `matchComponent(component, threshold)`: Matches the `documents` against one component in the SBOM and returns a `Match`<br/>- `match(sbom, threshold)`: Matches the `documents` against the complete SBOM and returns a `Match`<br/>- `matchDatabase(database, threshold)`: Matches the `documents` against the complete SBOM `database` and returns a `Match` |
| `Match`              | The result of a matching operation. It contains the matched SBOMs and their corresponding CSAF document. It contains the following properties:<br/>- `document`: The CSAF document this match was generated from<br/>- `product`: The CSAF product that generated the match<br/>- `matchedComponent`: The SBOM component that is matched to this document<br/>- `confidence`: The confidence of this match                                                                                                                                                                                                                              |
| `MatchingConfidence` | Since matching ist mostly not a 100 % match, we want to give some indication of the confidence we have in the matching (ranging from `0.0` to `1.0`)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |

## Confidence Levels

Each value between `0.0` and `1.0` can be used to indicate a confidence level. However, it is recommended to use the values defined in the table below or a multiplication of them. For example, if a `CaseInsensitiveMatch` is used in combination with a `DifferentSources`, the resulting confidence level would be `0.95 * 0.90 = 0.855`. The following table defines the known confidence levels and their meaning:

| Short Identifier                 | Confidence Level | Comment                                                                                                                                                                                                                                                             |
|----------------------------------|------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `DefinitelyNoMatch`              | `0.00`           | Indicates that the component is definitely not matched to the document.                                                                                                                                                                                             |
| `PartialStringMatch`             | `0.50`           | Indicates that a string property (e.g., the vendor name) of the product partially matches the component's string property.                                                                                                                                          |
| `MatchPackageNoVersion`          | `0.70`           | Indicates that the package name of the product matches the component's package name, but no version was specified. So in theory, all versions that are in the SBOM could be a match.                                                                                |
| `DifferentSources`               | `0.90`           | Indicates that the information comes from different sources (e.g., matching a vendor in a CPE to a vendor specified in a CSAF product tree category. This can be used to "multiply" the matching confidence with this value to adjust it for the different sources. |
| `CaseInsensitiveIgnoreDashMatch` | `0.90`           | Indicates a (string-based) match that is case-insensitive and ignores dashes. This is a relatively high match value, but not as high as a `CaseInsensitiveMatch`.                                                                                                   |
| `CaseInsensitiveMatch`           | `0.95`           | Indicates a (string-based) match that is case-insensitive. This is a high match value, but not as high as a `DefiniteMatch`.                                                                                                                                        |
| `DefiniteMatch`                  | `1.00`           | Indicates a definite match. This is the highest possible match value. This should be used if two properties match exactly -- either lexically or by rules defined in a specification. For example if one CPE matches another, this will be a `DefiniteMatch`.       |

## Matching Properties

Since much different information are available both on the security advisory and the SBOM document or node, we need a way to structure information to correlate between them. For example, the SBOM node might not directly indicate the version of the product, but it might specify a CPE which includes the version. On the other hand, the CSAF advisory might indicate the version and product name of the product, but not a CPE. In this case we want the matching to be able to correlate the information based on the properties (product name and version) contained in different places (CPE, categorized values). If we would just match based on a CPE, we would not be able to generate a match in this example.

Therefore, we define an (initial)  set of properties that can be used to establish a match. In general, it is important to know that a "property" holds a certain set of meta-data:
- `name`: The name of the property
- `value`: The value of the property. This can be a string or a more specialized structure, such as a product version or identifier
- `source`: The source of the property. Currently, we support extraction of the property from the CSAF/SBOM structure as well as from CPE and PURL identifiers contained in them

Furthermore, each property must support matching based on confidence levels by implementing (see [Matching Algorithm](#matching-algorithm) for more details):
- `confidenceMatching(otherProperty)` which returns a `MatchingConfidence`

The following properties are defined in this specification and each matching implementation MUST support them:

| Name              | Type              | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|-------------------|-------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `vendor`          | `StringProperty`  | The value of the property is a string containing the vendor of the vulnerable product. Possible sources include:<br/>- Branches ([`branches_t`](https://docs.oasis-open.org/csaf/csaf/v2.0/os/csaf-v2.0-os.html#312-branches-type)) in the CSAF advisory whose category is of type [`vendor`](https://docs.oasis-open.org/csaf/csaf/v2.0/os/csaf-v2.0-os.html#3122-branches-type---category)<br/>- The `vendor` property of the CPE specified in the [`product_identification_helper`](https://docs.oasis-open.org/csaf/csaf/v2.0/os/csaf-v2.0-os.html#3133-full-product-name-type---product-identification-helper) as well as of any CPE specified in the SBOM node<br/>- Any suitable property in the SBOM document indicating a vendor                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `product_name`    | `StringProperty`  | The value of the property is a string containing the product name of the vulnerable product. Possible sources include:<br/>- Branches ([`branches_t`](https://docs.oasis-open.org/csaf/csaf/v2.0/os/csaf-v2.0-os.html#312-branches-type)) in the CSAF advisory whose category is of type [`product_name`](https://docs.oasis-open.org/csaf/csaf/v2.0/os/csaf-v2.0-os.html#3122-branches-type---category)<br/>- The `product` property of the CPE specified in the [`product_identification_helper`](https://docs.oasis-open.org/csaf/csaf/v2.0/os/csaf-v2.0-os.html#3133-full-product-name-type---product-identification-helper) as well as of any CPE specified in the SBOM node<br/>- The `name` property of the PURL specified in the [`product_identification_helper`](https://docs.oasis-open.org/csaf/csaf/v2.0/os/csaf-v2.0-os.html#3133-full-product-name-type---product-identification-helper) as well as of any PURL specified in the SBOM node<br/>- Any suitable property in the SBOM document indicating a product name                                                                                                                                                                                                                                                                                                                                                                                                       |
| `product_version` | `VersionProperty` | The value of the property is a data structure that holds either a fixed version or a version range of the vulnerable product. Both fixed and ranged version are stored in the same property because we are matching properties of the same type against each other and we need to often match a range of the CSAF advisory against a fixed version on the SBOM. Possible sources include:<br/>- Branches ([`branches_t`](https://docs.oasis-open.org/csaf/csaf/v2.0/os/csaf-v2.0-os.html#312-branches-type)) in the CSAF advisory whose category is of type [`product_version`](https://docs.oasis-open.org/csaf/csaf/v2.0/os/csaf-v2.0-os.html#3122-branches-type---category) and [`product_version_range`](https://docs.oasis-open.org/csaf/csaf/v2.0/os/csaf-v2.0-os.html#3122-branches-type---category)<br/>- The `version` property of the CPE specified in the [`product_identification_helper`](https://docs.oasis-open.org/csaf/csaf/v2.0/os/csaf-v2.0-os.html#3133-full-product-name-type---product-identification-helper) as well as of any CPE specified in the SBOM node<br/>- The `version` property of the PURL specified in the [`product_identification_helper`](https://docs.oasis-open.org/csaf/csaf/v2.0/os/csaf-v2.0-os.html#3133-full-product-name-type---product-identification-helper) as well as of any PURL specified in the SBOM node<br/>- Any suitable property in the SBOM document indicating a product name |
| `cpe`             | `CPEProperty`     | The value of the property is a CPE identifier. Possible sources include:<br/>- The `cpe` property of the CPE specified in the [`product_identification_helper`](https://docs.oasis-open.org/csaf/csaf/v2.0/os/csaf-v2.0-os.html#3133-full-product-name-type---product-identification-helper) as well as of any CPE specified in the SBOM node<br/>- Any suitable property in the SBOM document indicating a CPE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `purl`            | `PURLProperty`    | The value of the property is a PURL identifier. Possible sources include:<br/>- The `purl` property of the PURL specified in the [`product_identification_helper`](https://docs.oasis-open.org/csaf/csaf/v2.0/os/csaf-v2.0-os.html#3133-full-product-name-type---product-identification-helper) as well as of any PURL specified in the SBOM node<br/>- Any suitable property in the SBOM document indicating a PURL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |

Note: the `cpe` and `purl` properties might be merged into a more generalized property in the future and extended to other software identifiers.

## Matching Algorithm

This section describes the matching algorithm used to match the properties of a CSAF advisory against the properties of an SBOM document or node. The algorithm is based on the properties defined in the previous section and matching them to other properties of the same type (resulting in a `MatchingConfidence`). Information on how a property is matched is contained in [Matching a Property with Confidence](#matching-a-property-with-confidence).

The matching is divided into two parts:
- First, the properties `cpe` and `purl` are matched against each other. If a [`DefiniteMatch`](#confidence-levels) is found, the matching is done and the confidence is returned. If no match is found, the algorithm continues to the next step.
- Next, the properties `vendor`, `product_name`, and `product_version` are matched against each other. The individual confidences of each property are multiplied with each other, resulting in the final confidence value.

Finally, the confidence value is measured against the `threshold`. If it is greater than the threshold, a `Match` structure is returned containing the CSAF advisory, the vulnerable product that matched, the SBOM node and the confidence value. Otherwise, no match is returned.

### Matching a Property with Confidence

For each `advisory` and each `node` in the SBOM all property values of a certain type are extracted and stored into two distinct sets. Then, all combinations of the two sets are matched against each other using the `confidenceMatching` method of the property. Finally, the greatest confidence value is returned as the confidence of the property.

#### Matching String Properties

The confidence of a match between string-based properties is determined by comparing the string values.
- If the strings are equal, the confidence is [`DefiniteMatch`](#confidence-levels).
- If the strings are equal ignoring case, the confidence is [`CaseInsensitiveMatch`](#confidence-levels).
- If the strings are equal ignoring case and ignoring dashes/underscores, the confidence is
  [`CaseInsensitiveIgnoreDashMatch`](#confidence-levels).
- Otherwise, the confidence is [`DefinitelyNoMatch`](#confidence-levels).

Finally, if the sources of the properties are different, the confidence value is multiplied by [`DifferentSources`](#confidence-levels).

#### Matching Version Properties

The confidence of a match between version-based properties is determined by comparing the version values.
- If the version is a fixed version and the other is a fixed version, the confidence is [`DefiniteMatch`](#confidence-levels) if the versions are equal, otherwise [`DefinitelyNoMatch`](#confidence-levels).
- If the version is a fixed version and the other is a range, the confidence is [`DefiniteMatch`](#confidence-levels) if the version is in the range, otherwise [`DefinitelyNoMatch`](#confidence-levels).
- If the version is a range and the other is a fixed version, the confidence is [`DefiniteMatch`](#confidence-levels) if the version is in the range, otherwise [`DefinitelyNoMatch`](#confidence-levels).
- If the version is a range and the other is a range, the confidence is [`DefiniteMatch`](#confidence-levels) if the ranges overlap, otherwise [`DefinitelyNoMatch`](#confidence-levels).

### Matching CPE and PURL Properties

The confidence of a match between CPE and PURL properties is determined by comparing the CPE and PURL values.
- If the CPE and PURL are equal according to their specification, the confidence is [`DefiniteMatch`](#confidence-levels).
- Since a version is optional in PURL, we use the [`MatchPackageNoVersion`](#confidence-levels) confidence level if the PURL has no version specified but would be a match based on the remaining attributes.